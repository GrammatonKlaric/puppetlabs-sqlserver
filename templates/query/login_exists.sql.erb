
GO
DECLARE
	@login as varchar(255) = '<%= @login %>',
	@is_disabled as tinyint = <%= @disabled ? 1 : 0 %>,
	@check_expiration as tinyint = <%= @check_expiration ? 1 : 0 %>,
	@check_policy as tinyint = <%= @check_policy ? 1 : 0 %>,
	@type_desc as varchar(50) = '<%= @type_desc %>',
	@default_db as varchar(255) = '<%= @default_database %>',
	@default_lang as varchar(50) = '<%= @default_language %>'
IF <% if @ensure == 'present' %>NOT<% end %> EXISTS(
    SELECT name FROM sys.sql_logins
    WHERE  name = '<%= @login %>') THROW 5100, 'ERROR: the login is not <%= @ensure %>', 10

IF <% if @ensure == 'present' %>NOT<% end %> EXISTS(
    SELECT name FROM sys.sql_logins
    WHERE
	    name = @login AND
	    type_desc = @type_desc AND
	    is_disabled = @is_disabled AND
	    default_database_name = @default_db AND
	    default_language_name = @default_lang AND
	    is_policy_checked = @check_policy AND
	    is_expiration_checked = @check_expiration
        )
BEGIN
    THROW 51000, 'ERROR The record does not exists', 10
END;
<% if @ensure == 'present' %>
ELSE
BEGIN
    /* If it does exist check for each role is in the correct state */
    <% @svrroles.each do |role, enable_bit| %>
        IF IS_SRVROLEMEMBER('<%= role %>','<%= @login %>') != <%= enable_bit %> THROW 51000, 'ERROR: a role is not correct for <%= role %>', 10
    <% end %>
END
<% end %>
GO
